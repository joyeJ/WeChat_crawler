
                        
                       
                        

                        
                        
                        <section class="" data-source="bj.96weixin.com"><p><img class=" __bg_gif" data-src="http://mmbiz.qpic.cn/mmbiz/z9433rAGTDcAxwKjcEELznfH8NjTj5XuibUhZIJqTWcvhvcK75ghkTDlrJVHSMr74HMkQbZdw46icoLcteqFsGpA/0?wx_fmt=gif" data-ratio="0.1819484240687679" data-w="698" src="http://mmbiz.qpic.cn/mmbiz/z9433rAGTDcAxwKjcEELznfH8NjTj5XuibUhZIJqTWcvhvcK75ghkTDlrJVHSMr74HMkQbZdw46icoLcteqFsGpA/0?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" style="width: auto !important; height: auto !important; visibility: visible !important;" data-order="0" data-fail="0"/></p></section><p><br/></p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">一、 用兼容层封装数据类型</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">在这之前首先先思考一个问题，我们调用的C语言的函数，那么传进去的数据也一定要满足C语言的规范。虽然Python底层是C，但是做了高度抽象封装。那么它还符不符合C的要求呢？</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">首先，我们来看个例子，看看如果不利用兼容层会有什么问题：</p><p><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/Kad3LZzM7n6kOLEoklv3z5DlYnHz2lE2hhY5gupXABrohBvBomQNDiaicwg32fibzqWMJDSQelCCjTXeQHjViaq7bA/0?wx_fmt=png" data-ratio="1.020446096654275" data-w="538" src="http://mmbiz.qpic.cn/mmbiz_png/Kad3LZzM7n6kOLEoklv3z5DlYnHz2lE2hhY5gupXABrohBvBomQNDiaicwg32fibzqWMJDSQelCCjTXeQHjViaq7bA/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1" style="width: auto !important; height: auto !important; visibility: visible !important;" data-fail="0"/><br/>                        <span style="line-height: 25.6px;"> </span><span style="color: rgb(119, 119, 119); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 12px; line-height: 16px; text-align: center; background-color: rgb(255, 255, 255);">Python学习交流 330637182 群内每天更新相关资料</span></p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">果不其然，就这么报错了！看样子其中有一些任然可以，有一些就不符合要求了。</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">其实，除了整数，字符串和字节对象以外的所有Python类型必须要通过它们相应的ctypes类型来包装，因此我们可以用兼容层将他们封装成需要的C数据类型。</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">在来看看如下的代码：</p><p><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/Kad3LZzM7n6kOLEoklv3z5DlYnHz2lE2y6C6lCrc6TibyQgvKcxOxFLx6fjJAysZtPV85RJebQ4JzosEZiaXOUiaA/0?wx_fmt=png" data-ratio="0.6378269617706237" data-w="497" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 370px !important; height: 235.99597585513078px !important;"/><br/><span style="color: rgb(119, 119, 119); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 12px; line-height: 16px; text-align: center;  background-color: rgb(255, 255, 255);">                           Python学习交流 330637182 群内每天更新相关资料</span></p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">我们使用 c_double 类型封装了我们的浮点数。果不其然，我们就可以正确运行我们的代码了。看样子，兼容层，帮我们做了一些事情。</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">那么究竟兼容层棒我们做了什么呢？我们能不能利用这个机制传递我们自定义的类型呢？当然是有办法的！</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">二、 自定义类型</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">话不多说，直接上代码：</p><p><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz_png/Kad3LZzM7n6kOLEoklv3z5DlYnHz2lE2pTSYaglqPAxFV1BBTzbVHyUlI2rBM2DiaibY1wB0THbhNazicp2GE2XCw/0?wx_fmt=png" data-ratio="1.432642487046632" data-w="386" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJDQzA1MTVGNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJDQzA1MTYwNkE2MjExRTRBRjEzODVCM0Q0NEVFMjFBIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkNDMDUxNUQ2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkNDMDUxNUU2QTYyMTFFNEFGMTM4NUIzRDQ0RUUyMUEiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6p+a6fAAAAD0lEQVR42mJ89/Y1QIABAAWXAsgVS/hWAAAAAElFTkSuQmCC" style="width: 370px !important; height: 530.0777202072538px !important;"/></p><p>                              <span style="color: rgb(119, 119, 119); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 12px; line-height: 16px; text-align: center;  background-color: rgb(255, 255, 255);">Python学习交流 330637182 群内每天更新相关资料<br/></span></p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">看来我们给的这个Flasks类型完全可以传入，果然有这么一种机制。</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">从以上代码可以看出来，其实真正的秘诀就在于_as_parameter_ 属性。</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">那么究竟发生了什么呢？</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">其实，ctypes参数转换是允许使用自定义的类的实例来作为ctypes函数参数的。ctypes会查找 _as_parameter_ 属性并用作函数参数。当然，这必须符合ctypes的要求（如果不包装则只能是整数，字符串或字节）。</p><p style="margin-top: 18px; color: rgb(34, 34, 34); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 28px; white-space: normal; background-color: rgb(255, 255, 255);">简单来说，就是，通过 _as_parameter_ 参数来将我们的数据转换成符合C语言要求的类型，说到底还是使用兼容层。当然，如果你不想把数据在_as_parameter_ 中存死，可以使用描述符让数据临时请求。这样就能时间动态生成参数了。</p><p><span style="color: rgb(119, 119, 119); font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', 'Helvetica Neue', Arial, sans-serif; font-size: 12px; line-height: 16px; text-align: center;  background-color: rgb(255, 255, 255);"><br/></span><br/></p>
                    